{% extends "navbar.html" %}

{% block content %}
<!-- Model Navigation -->
<div class="modelnav" id="modelnav">
    <div class="model-section-left">
        <h2 style="margin-bottom: 20px;">Upload Content</h2>
        {% if error %}
            <div class="alert alert-danger">
                {{ error }}
            </div>
        {% endif %}
        <div class="panel1">
            <div class="panel-body">
                <p id="uploads_img" style="margin: 0; color: black;">Up load your images</p>

                <!-- Placeholder to show when job is processing -->
                <div id="processing-message" style="display:none;">
                    <p>Processing your files...</p>
                </div>

                <!-- Image Display Area (Initially hidden) -->
                <div id="image-display" style="display:none;">
                    <!-- <h3>Processed Images:</h3> -->
                    <div id="images-container"></div>
                </div>
            </div>
        </div>

        <!-- Form for uploading files -->
        <form id="upload-form" method="POST" enctype="multipart/form-data">
            <div style="display: flex; justify-content: center; margin-top: 10px;">
                <input type="file" name="file" id="file-input" multiple required>
                <input type="submit" value="Prediction" style="background-color: #ff7700; color: white;">
            </div>
        </form>
    </div>

    <div class="model-section-right">
        <h2>Equipment List</h2>
        <div class="info-box-container">
            <div class="info-box">
                <p>Item 1: Information about the model.</p>
                <p>More details can be added here as needed.</p>
            </div>
        </div>
    </div>
</div>

<!-- Satisfaction level with emoji -->
<div class="Satisfaction-level">
    <div class="emoji" id="emoji">üòê</div>

    <div class="stars white">
        <input type="radio" name="star" id="star1" value="1">
        <label for="star1" onclick="changeEmoji(1)">‚òÖ</label>
        <input type="radio" name="star" id="star2" value="2">
        <label for="star2" onclick="changeEmoji(2)">‚òÖ</label>
        <input type="radio" name="star" id="star3" value="3">
        <label for="star3" onclick="changeEmoji(3)">‚òÖ</label>
        <input type="radio" name="star" id="star4" value="4">
        <label for="star4" onclick="changeEmoji(4)">‚òÖ</label>
        <input type="radio" name="star" id="star5" value="5">
        <label for="star5" onclick="changeEmoji(5)">‚òÖ</label>
    </div>
</div>

<!-- JavaScript for handling file uploads and job status -->
<script>
    document.getElementById('upload-form').onsubmit = async function (e) {
        e.preventDefault();
        const formData = new FormData();
        const files = document.getElementById('file-input').files;
        for (let i = 0; i < files.length; i++) {
            formData.append('file', files[i]);
        }

        // Send files to the server
        const response = await fetch('/rq-test/success', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();
        if (data.job_id) {
            const imagesContainer = document.getElementById('images-container');
            while (imagesContainer.firstChild) {
            imagesContainer.removeChild(imagesContainer.firstChild);
            }
            document.getElementById('uploads_img').style.display = 'none';
            document.getElementById('processing-message').style.display = 'block';
            checkJobStatus(data.job_id);
        }
    };

    // Poll the job status
    async function checkJobStatus(jobId) {
        const response = await fetch(`/rq-test/job-status/${jobId}`);
        const data = await response.json();
        console.log(data.status);

        if (data.status === 'finished') {
            document.getElementById('processing-message').style.display = 'none';
            document.getElementById('image-display').style.display = 'block';

            // Display the processed images
            const imagesContainer = document.getElementById('images-container');
            data.result.forEach(imagePath => {
                const img = document.createElement('img');
                // img.src = imagePath;
                img.src = "{{ url_for('static', filename='') }}" + imagePath
                img.alt = 'Processed Image';
                img.style.width = '200px';
                img.style.margin = '10px';
                imagesContainer.appendChild(img);
            });
        } else if (data.status === 'in-progress') {
            setTimeout(() => checkJobStatus(jobId), 2000);  // Poll every 2 seconds
        } else {
            alert('Job failed or unknown status.');
        }
    }

    function changeEmoji(stars) {
        var emojiElement = document.getElementById("emoji");
        const labels = document.querySelectorAll('.stars label');

        labels.forEach((label, index) => {
            label.addEventListener('click', function () {
                labels.forEach((l, i) => {
                    l.style.color = i <= index ? "gold" : "gray";
                });
            });
        });

        switch (stars) {
            case 1:
                emojiElement.textContent = "üòû";
                break;
            case 2:
                emojiElement.textContent = "üôÅ";
                break;
            case 3:
                emojiElement.textContent = "üòê";
                break;
            case 4:
                emojiElement.textContent = "üôÇ";
                break;
            case 5:
                emojiElement.textContent = "üòÑ";
                break;
            default:
                emojiElement.textContent = "üòê";
        }
    }
</script>
{% endblock %}
